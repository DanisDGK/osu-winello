#!/usr/bin/env bash
Info()
{ 
    echo -e '\033[1;34m'"Winello:\033[0m $*";
}

export PATH="$HOME/.local/share/osuconfig/wine-osu/bin:$PATH" #Path to wine-osu
export WINEARCH=win64
export WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix"
osuinstall=$(</"$HOME/.local/share/osuconfig/osupath")
export OSUPATH="$osuinstall"
export vblank_mode=0            #disables vsync for mesa
export __GL_SYNC_TO_VBLANK=0    #disables vsync for NVIDIA
export WINE_BLOCK_GET_VERSION=1 #blocks wine's version on hwsmm's wine-osu (ty oglfreak)

function help()
{
    Info "osu-wine: Runs osu!
    osu-wine --winecfg : Runs winecfg on the osu! Wineprefix
    osu-wine --winetricks: Install packages on osu! Wineprefix
    osu-wine --update: Updates wine-osu to latest version
    osu-wine --w10fonts: Installs Windows 10 fonts from iso (5GB) (Needed for JP characters etc.)
    osu-wine --fixprefix: Reinstalls the osu! Wineprefix
    osu-wine --info: Troubleshooting and more info
    osu-wine --lutris: Copies wine-osu to lutris"
}

function checkshort() #Deletes Wine's automatic shortcuts
{
    if [ -e "$HOME/.local/share/applications/wine/Programs/osu!.desktop" ] ; then
    rm -f "$HOME/.local/share/applications/wine/Programs/osu!.desktop" ; fi

    DESKTOPDIR=$(xdg-user-dir DESKTOP)
    if [ -e "$DESKTOPDIR/osu!.desktop" ] ; then
    rm -f "$DESKTOPDIR/osu!.desktop" ; fi

    if [ -e "$DESKTOPDIR/osu!.lnk" ] ; then
    rm -f "$DESKTOPDIR/osu!.lnk" ; fi

    echo "Checkshort done" >> "$HOME/.local/share/osuconfig/checkshort"
}

function update()
{   
    if [ "$CURRENTGLIBC" \< "$MINGLIBC" ]; then
    Info "1 - Ubuntu and derivatives (Linux Mint, Pop_OS, Zorin OS etc.)
          2 - openSUSE Tumbleweed
          3 - openSUSE Leap 15.3
          4 - exit"
    read -r -p "$(Info "Choose your distro: ")" distro
    case "$distro" in 
        '1')
        sudo apt update
        sudo apt install wine-osu
        rm -rf "$HOME/.local/share/osuconfig/wine-osu"
        cp -r /opt/wine-osu "$HOME/.local/share/osuconfig/wine-osu"
        Info "Update is completed!"
        ;;
        '2')
        zypper refresh
        zypper install wine-osu
        rm -rf "$HOME/.local/share/osuconfig/wine-osu"
        cp -r /opt/wine-osu "$HOME/.local/share/osuconfig/wine-osu" 
        Info "Update is completed!"
        ;;
        '3')
        zypper refresh
        zypper install wine-osu
        rm -rf "$HOME/.local/share/osuconfig/wine-osu"
        cp -r /opt/wine-osu "$HOME/.local/share/osuconfig/wine-osu"
        Info "Update is completed!"
        ;; 
	'4')
	exit 0
	;;
    esac

    else
    git -C "$HOME/.local/share/osuconfig/update" pull --quiet
    bash "/$HOME/.local/share/osuconfig/update/osu-winello.sh" update
    fi
}

case "$1" in
    '')
	wine "$OSUPATH/osu!.exe" #osu! launcher

    #Checks if Wine creates shortcuts which aren't supposed to be used
    if [ ! -e "$HOME/.local/share/osuconfig/checkshort" ] ; then
    checkshort
    fi
	;;

  	'--winecfg')
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" winecfg
	;;

	'--winetricks')
	WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" winetricks "${@:2}"
	;;

	'--update')
	update
	;;


    '--lutris')
    if [ -d "$HOME/.local/share/lutris" ]; then
    Info "Lutris was found, do you want to copy wine-osu there? (y/n)"
    read -r -p "$(Info "Choose your option: ")" lutrischoice
        if [ "$lutrischoice" = 'y' ] || [ "$lutrischoice" = 'Y' ]; then
            if [ -d "$HOME/.local/share/lutris/runners/wine" ]; then
                if [ -d "$HOME/.local/share/lutris/runners/wine/wine-osu" ]; then
                Info "wine-osu is already installed in Lutris, skipping..."
                else
                cp -r "$HOME/.local/share/osuconfig/wine-osu" "$HOME/.local/share/lutris/runners/wine" ; fi
            else
            mkdir "$HOME/.local/share/lutris/runners/wine"
            cp -r "$HOME/.local/share/osuconfig/wine-osu" "$HOME/.local/share/lutris/runners/wine" ; fi
        else
        Info "Skipping.."; fi
    else
    Info "Lutris not detected; if you installed it, launch it at least once."
    fi

    ;;

    '--w10fonts')
    git -C "$HOME/.local/share/osuconfig/update" pull --quiet
    bash "$HOME/.local/share/osuconfig/update/osu-winello.sh" w10fonts
    ;;

    '--fixprefix')
    Info "Deleting old Wineprefix..."
    rm -rf "$HOME/.local/share/wineprefixes/osu-wineprefix"
    Info "Configuring new Wineprefix..."
    WINEARCH=win64 WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" winetricks -q -f dotnet48 gdiplus_winxp comctl32 cjkfonts 
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" winetricks -q win2k3
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" wine reg add "HKEY_CURRENT_USER\\Software\\Wine" /v HideWineExports /t REG_SZ /d Y
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" wine reg add "HKEY_CURRENT_USER\\Software\\Wine\\FileOpenAssociations" /v Enable /d N
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" wine reg add "HKEY_CLASSES_ROOT\folder\shell\open\command"
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" wine reg delete "HKEY_CLASSES_ROOT\folder\shell\open\ddeexec" /f
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" wine reg add "HKEY_CLASSES_ROOT\folder\shell\open\command" /f /ve /t REG_SZ /d "/home/$USER/.local/bin/folderfixosu xdg-open \"%1\""
    Info "Wineprefix is now working; launch osu! with osu-wine"
    ;;

    '--info')
    Info "You can find more troubleshooting and info at here: https://osu.ppy.sh/community/forums/topics/1248084?n=1"
    ;;

	'help')
	help
	;;

esac
