#!/usr/bin/env bash
Info()
{ 
    echo -e '\033[1;34m'"Winello:\033[0m $*";
}

#Welcome to your osu! launch script!
#Most stuff here is explained with comments, but if you just need to add
#something to osu (example: adding gamemode) see line ~94, you'll find the osu! launcher there.

export WINEESYNC=1 #enables esync
export WINEFSYNC=1 #enables fsync (when possible)
export PATH="$HOME/.local/share/osuconfig/wine-osu/bin:$PATH" #Path to wine-osu
export WINEARCH=win32
export WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix"
osuinstall=$(</"$HOME/.local/share/osuconfig/osupath")
export OSUPATH="$osuinstall"
export vblank_mode=0            #disables vsync for mesa
export __GL_SYNC_TO_VBLANK=0    #disables vsync for NVIDIA
export WINEDLLOVERRIDES=winemenubuilder.exe=d# #blocks wine from creating .desktop files

function help()
{
    Info "Script features:
    osu-wine: Runs osu!
    osu-wine --winecfg : Runs winecfg on the osu! Wineprefix
    osu-wine --winetricks: Install packages on osu! Wineprefix
    osu-wine --regedit: Opens regedit on osu! Wineprefix
    osu-wine --kill: Kills osu! and related processes in osu! Wineprefix
    osu-wine --kill9: Kills osu! but with wineserver -k9
    osu-wine --update: Updates wine-osu to latest version
    osu-wine --w10fonts: Installs Windows 10 fonts from either GitHub or ISO (Needed to fix P characters etc.)
    osu-wine --fixprefix: Reinstalls the osu! Wineprefix from system
    osu-wine --info: Troubleshooting and more info
    osu-wine --remove: Uninstalls osu! and the script
    osu-wine --lutris: Copies wine-osu to lutris (only the Wine version)
    osu-wine --changedir: Changes directory of the install according to the user
    osu-wine --devserver <address>: Runs osu on with the specified devserver"
}

function checkshort()
{
    if [ -e "$HOME/.local/share/applications/wine/Programs/osu!.desktop" ] ; then
    rm -f "$HOME/.local/share/applications/wine/Programs/osu!.desktop" ; fi

    DESKTOPDIR=$(xdg-user-dir DESKTOP)
    if [ -e "$DESKTOPDIR/osu!.lnk" ] ; then
    rm -f "$DESKTOPDIR/osu!.lnk" ; fi
}

function update()
{   
    git -C "$HOME/.local/share/osuconfig/update" pull --quiet
    bash "/$HOME/.local/share/osuconfig/update/osu-winello.sh" update
}

case "$1" in
    '')
	wine "$OSUPATH/osu!.exe" #osu! launcher
	checkshort
	;;

    '--devserver')
    wine "$OSUPATH/osu!.exe" -devserver "$2" #osu! launcher with specified devserver
    checkshort
    ;;

    '--regedit')
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" regedit
    ;;

  	'--winecfg')
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" winecfg
	;;

	'--winetricks')
	WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" winetricks "${@:2}"
	;;
    
    '--changedir')
    Info "Please choose your new directory:"

    newdir="$(zenity --file-selection --directory)"
    lastdir=$(</"$HOME/.local/share/osuconfig/osupath")
    rm -f "$HOME/.local/share/osuconfig/osupath"

    if [ -d "$newdir/osu!" ] || [ -s "$newdir/osu!.exe" ]; then
    Info "osu! folder/game already exists: skipping.."

    if [ -d "$newdir/osu!" ]; then
    OSUPATH="$newdir/osu!"
    echo "$newdir" > "$HOME/.local/share/osuconfig/osupath"

    Info "Change done from '\033$lastdir\033' to '\033$newdir\033'!"

    Info "Do you want to delete the previous install?"
    read -r -p "$(Info "Choose your option (y/n): ")" dirchoice
    if [ "$dirchoice" = 'y' ] || [ "$dirchoice" = 'Y' ]; then

    read -r -p "$(Info "Are you sure? This will delete your files! (y/n)")" dirchoice2
    if [ "$dirchoice2" = 'y' ] || [ "$dirchoice2" = 'Y' ]; then
    rm -rf "$lastdir/osu!" && Info "Cleaning done!" ; else Info "Skipping..." ; fi
    else 
    Info "Skipping.." ; fi ; fi

    if [ -s "$newdir/osu!.exe" ]; then
    OSUPATH="$newdir"
    echo "$newdir" > "$HOME/.local/share/osuconfig/osupath" 
    
    Info "Change done from '\033$lastdir\033' to '\033$newdir\033'!"

    Info "Do you want to delete the previous install?"
    read -r -p "$(Info "Choose your option (y/n): ")" dirchoice
    if [ "$dirchoice" = 'y' ] || [ "$dirchoice" = 'Y' ]; then

    read -r -p "$(Info "Are you sure? This will delete your files! (y/n)")" dirchoice2
    if [ "$dirchoice2" = 'y' ] || [ "$dirchoice2" = 'Y' ]; then
    rm -rf "$lastdir/osu!" && Info "Cleaning done!" ; else Info "Skipping..." ; fi
    else 
    Info "Skipping.." ; fi ; fi
    
    else
    mkdir "$newdir/osu!"
    OSUPATH="$newdir/osu!"
    echo "$newdir" > "$HOME/.local/share/osuconfig/osupath"

    Info "Downloading osu! to your new install.."
    wget -O "$OSUPATH/osu!.exe" "http://m1.ppy.sh/r/osu!install.exe" && wgetcheck6="$?"
    
    if [ ! "$wgetcheck6" = 0 ] ; then
    Info "wget failed; trying with --no-check-certificate.."
    wget --no-check-certificate -O "$OSUPATH/osu!.exe" "http://m1.ppy.sh/r/osu!install.exe" ; fi
    
    Info "Change done from '\033$lastdir\033' to '\033$newdir\033'!"

    Info "Do you want to delete the previous install?"
    read -r -p "$(Info "Choose your option (y/n): ")" dirchoice
    if [ "$dirchoice" = 'y' ] || [ "$dirchoice" = 'Y' ]; then

    read -r -p "$(Info "Are you sure? This will delete your files! (y/n)")" dirchoice2
    if [ "$dirchoice2" = 'y' ] || [ "$dirchoice2" = 'Y' ]; then
    rm -rf "$lastdir/osu!" && Info "Cleaning done!" ; else Info "Skipping..." ; fi

    else 
    Info "Skipping.." ; fi
    fi
    ;;

    '--remove')
    bash "$HOME/.local/share/osuconfig/update/osu-winello.sh" uninstall
    ;;

    '--kill')
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" wineserver -k
    ;;

    '--kill9')
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" wineserver -k9
    ;;

	'--update')
	update
	;;

    '--lutris')
    if [ -d "$HOME/.local/share/lutris" ]; then
    Info "Lutris was found, do you want to copy wine-osu there? (y/n)"
    read -r -p "$(Info "Choose your option: ")" lutrischoice
        if [ "$lutrischoice" = 'y' ] || [ "$lutrischoice" = 'Y' ]; then
            if [ -d "$HOME/.local/share/lutris/runners/wine" ]; then
                if [ -d "$HOME/.local/share/lutris/runners/wine/wine-osu" ]; then
                Info "wine-osu is already installed in Lutris, skipping..."
                else
                cp -r "$HOME/.local/share/osuconfig/wine-osu" "$HOME/.local/share/lutris/runners/wine" ; fi
            else
            mkdir "$HOME/.local/share/lutris/runners/wine"
            cp -r "$HOME/.local/share/osuconfig/wine-osu" "$HOME/.local/share/lutris/runners/wine" ; fi
        else
        Info "Skipping.."; fi
    else
    Info "Lutris not detected; if you installed it, launch it at least once."
    fi
    ;;

    '--w10fonts')
    git -C "$HOME/.local/share/osuconfig/update" pull --quiet
    bash "$HOME/.local/share/osuconfig/update/osu-winello.sh" w10fonts
    ;;

    '--fixprefix')
    Info "Deleting old Wineprefix..."
    rm -rf "$HOME/.local/share/wineprefixes/osu-wineprefix"
    
    Info "Configuring new Wineprefix..."
    WINEARCH=win32 WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" winetricks -q -f dotnet48 gdiplus_winxp comctl32 cjkfonts 
    if [ -d "/etc/linuxmint" ] ; then
    Info "Mint detected; installing gdiplus to fix..."
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" winetricks -q -f gdiplus ; fi
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" winetricks -q win2k3
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" wine reg add "HKEY_CURRENT_USER\\Software\\Wine" /v HideWineExports /t REG_SZ /d Y
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" wine reg add "HKEY_CURRENT_USER\\Software\\Wine\\FileOpenAssociations" /v Enable /d N
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" wine reg add "HKEY_CURRENT_USER\Software\Wine\DllOverrides" /v winemenubuilder /t REG_SZ /d ""
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" wine reg add "HKEY_CLASSES_ROOT\folder\shell\open\command"
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" wine reg delete "HKEY_CLASSES_ROOT\folder\shell\open\ddeexec" /f
    WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" wine reg add "HKEY_CLASSES_ROOT\folder\shell\open\command" /f /ve /t REG_SZ /d "/home/$USER/.local/bin/folderfixosu xdg-open \"%1\""
    
    if [ ! -d "$HOME/.local/share/wineprefixes/osu-wineprefix/drive_c/winestreamproxy" ] ; then
    Info "Configuring Winestreamproxy (Discord RPC)"
    wget --no-check-certificate "https://github.com/openglfreak/winestreamproxy/releases/download/v2.0.3/winestreamproxy-2.0.3-i386.tar.gz" --output-document "/tmp/winestreamproxy-2.0.3-i386.tar.gz"
    mkdir -p "/tmp/winestreamproxy"
    tar -xf "/tmp/winestreamproxy-2.0.3-i386.tar.gz" -C "/tmp/winestreamproxy"
    WINE="$HOME/.local/share/osuconfig/wine-osu/bin/wine" WINEPREFIX="$HOME/.local/share/wineprefixes/osu-wineprefix" bash "/tmp/winestreamproxy/install.sh"
    rm -f "/tmp/winestreamproxy-2.0.3-i386.tar.gz"
    rm -rf "/tmp/winestreamproxy" ; fi

    Info "Wineprefix is now working; launch osu! with osu-wine"
    ;;

    '--info')
    Info "Need info?:
    Wineprefix location: ~/.local/share/wineprefixes/osu-wineprefix
    osu! folder: '$OSUPATH'
    
    If you need to add more options to osu!, see around line 86 of the script (ex. nano ~/.local/bin/osu-wine)

    You can run 'osu-wine help' to see all the script's functions (fix prefix, w10 fonts etc.)
    You can find more troubleshooting and info at here: https://osu.ppy.sh/community/forums/topics/1248084?n=1"
    ;;

	'help')
	help
	;;

    '--help')
    help
    ;;

esac
